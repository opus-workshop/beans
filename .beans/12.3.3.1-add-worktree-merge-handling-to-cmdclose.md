id: 12.3.3.1
title: Add worktree merge handling to cmd_close
slug: add-worktree-merge-handling-to-cmdclose
status: in_progress
priority: 1
created_at: 2026-02-03T07:44:04.862647Z
updated_at: 2026-02-04T02:02:11.238186Z
description: "## What to implement\n\nModify `cmd_close()` in `src/commands/close.rs` to handle worktree merge after verify passes.\n\n### Changes to make\n\n1. **Add import** at top of file:\n   ```rust\n   use crate::worktree::{detect_worktree, commit_worktree_changes, merge_to_main, cleanup_worktree, MergeResult};\n   ```\n\n2. **Add worktree handling after verify passes** (after line ~235, where \"Verify passed\" is printed):\n   ```rust\n   // After verify passes, handle worktree merge\n   if let Some(worktree_info) = detect_worktree()? {\n       // Commit any uncommitted changes\n       commit_worktree_changes(&format!(\"Close bean {}: {}\", id, bean.title))?;\n       \n       // Merge to main\n       match merge_to_main(&worktree_info, id)? {\n           MergeResult::Success | MergeResult::NothingToCommit => {\n               // Continue to archive\n           }\n           MergeResult::Conflict { files } => {\n               eprintln!(\"Merge conflict in files: {:?}\", files);\n               eprintln!(\"Resolve conflicts and run `bn close {}` again\", id);\n               return Ok(()); // Don't archive yet\n           }\n       }\n   }\n   ```\n\n3. **Add worktree cleanup after archiving** (after bean is archived, before \"Closed bean\" print):\n   ```rust\n   // Clean up worktree after successful close\n   // Note: We need to detect again as we're still in the worktree\n   if let Some(worktree_info) = detect_worktree()? {\n       if let Err(e) = cleanup_worktree(&worktree_info) {\n           eprintln!(\"Warning: Failed to cleanup worktree: {}\", e);\n           // Don't fail the close for cleanup issues\n       }\n   }\n   ```\n\n## Files\n- src/commands/close.rs (modify — add worktree handling)\n\n## Context\n\n### Worktree functions (from src/worktree.rs)\n```rust\npub fn detect_worktree() -> Result<Option<WorktreeInfo>>;\npub fn commit_worktree_changes(message: &str) -> Result<bool>;\npub fn merge_to_main(info: &WorktreeInfo, bean_id: &str) -> Result<MergeResult>;\npub fn cleanup_worktree(info: &WorktreeInfo) -> Result<()>;\n\npub enum MergeResult {\n    Success,\n    Conflict { files: Vec<String> },\n    NothingToCommit,\n}\n```\n\n### cmd_close location for insertion\nAfter the \"Verify passed\" println (around line 235):\n```rust\n                println!(\"Verify passed for bean {}\", id);\n            }\n        }\n\n        // ← INSERT WORKTREE HANDLING HERE\n\n        // Close the bean\n        bean.status = crate::bean::Status::Closed;\n```\n\n## Acceptance\n- [ ] `cmd_close` calls `detect_worktree()` after verify passes\n- [ ] If in worktree, commits changes and merges to main\n- [ ] If merge conflict, aborts and returns without archiving\n- [ ] After archiving, cleans up worktree\n- [ ] `cargo build` succeeds\n\n## Produces\n- close_worktree_handling\n"
parent: 12.3.3
verify: cargo build
claimed_at: 2026-02-04T02:02:11.238186Z
