id: 12.3.3.2
title: Add worktree merge integration tests for close
slug: add-worktree-merge-integration-tests-for-close
status: in_progress
priority: 2
created_at: 2026-02-03T07:44:22.016957Z
updated_at: 2026-02-04T02:02:11.290420Z
description: "## What to implement\n\nAdd integration tests for worktree merge handling in `cmd_close`.\n\n### Tests to add\n\nAdd a new test submodule in `src/commands/close.rs` inside `mod tests`:\n\n```rust\n// Inside mod tests, add:\nmod worktree_merge {\n    use super::*;\n    \n    // Helper to create a git repo with worktree for testing\n    fn setup_git_worktree_test() -> (TempDir, PathBuf, PathBuf) {\n        // Creates:\n        // - main repo with .beans/\n        // - worktree checked out to feature branch\n        // Returns (tempdir, main_beans_dir, worktree_beans_dir)\n    }\n    \n    #[test]\n    fn test_close_in_worktree_commits_and_merges() {\n        // 1. Create git repo with worktree\n        // 2. Create bean in worktree's .beans/\n        // 3. Make changes in worktree\n        // 4. Call cmd_close\n        // 5. Verify: changes committed, merged to main\n    }\n    \n    #[test]\n    fn test_close_with_merge_conflict_aborts() {\n        // 1. Create git repo with worktree\n        // 2. Create conflicting changes in main and worktree\n        // 3. Create bean in worktree\n        // 4. Call cmd_close\n        // 5. Verify: bean NOT closed, merge aborted, error message\n    }\n    \n    #[test]\n    fn test_close_in_main_worktree_skips_merge() {\n        // 1. Create git repo (no worktree)\n        // 2. Create bean\n        // 3. Call cmd_close\n        // 4. Verify: closes normally, no merge attempted\n    }\n    \n    #[test]\n    fn test_close_outside_git_repo_works() {\n        // 1. Use regular tempdir (no git)\n        // 2. Create bean\n        // 3. Call cmd_close\n        // 4. Verify: closes normally\n    }\n}\n```\n\n## Files\n- src/commands/close.rs (modify â€” add test module)\n\n## Context\n\n### Existing test setup helper\n```rust\nfn setup_test_beans_dir() -> (TempDir, std::path::PathBuf) {\n    let dir = TempDir::new().unwrap();\n    let beans_dir = dir.path().join(\".beans\");\n    fs::create_dir(&beans_dir).unwrap();\n    (dir, beans_dir)\n}\n```\n\n### Git commands for test setup\n```rust\n// Initialize git repo\nCommand::new(\"git\").args([\"init\"]).current_dir(&path).output()?;\nCommand::new(\"git\").args([\"config\", \"user.email\", \"test@test.com\"]).current_dir(&path).output()?;\nCommand::new(\"git\").args([\"config\", \"user.name\", \"Test\"]).current_dir(&path).output()?;\n\n// Create worktree\nCommand::new(\"git\").args([\"checkout\", \"-b\", \"main\"]).current_dir(&path).output()?;\nCommand::new(\"git\").args([\"worktree\", \"add\", \"../worktree\", \"-b\", \"feature\"]).current_dir(&path).output()?;\n```\n\n## Acceptance\n- [ ] `test_close_in_worktree_commits_and_merges` passes\n- [ ] `test_close_with_merge_conflict_aborts` passes\n- [ ] `test_close_in_main_worktree_skips_merge` passes\n- [ ] `test_close_outside_git_repo_works` passes\n- [ ] `cargo test close::tests::worktree_merge` passes\n\n## Produces\n- close_worktree_integration\n\n\n## Requires\n- close_worktree_handling\n"
parent: 12.3.3
verify: cargo test close::tests::worktree_merge
claimed_at: 2026-02-04T02:02:11.290420Z
