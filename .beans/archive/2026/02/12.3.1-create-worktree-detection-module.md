id: 12.3.1
title: Create worktree detection module
slug: create-worktree-detection-module
status: closed
priority: 2
created_at: 2026-02-03T07:27:24.179985Z
updated_at: 2026-02-03T07:36:12.836839Z
description: |
  ## What to implement

  Create a new `src/worktree.rs` module with functions to detect if running in a git worktree.

  ### Functions to write

  1. **`WorktreeInfo` struct**
     ```rust
     pub struct WorktreeInfo {
         pub main_path: PathBuf,      // Path to main worktree
         pub worktree_path: PathBuf,  // Current worktree path
         pub branch: String,          // Branch name of current worktree
     }
     ```

  2. **`detect_worktree() -> Result<Option<WorktreeInfo>>`**
     - Run `git worktree list --porcelain`
     - Parse output to find main worktree and current worktree
     - Return `None` if not in a git repo or in the main worktree
     - Return `Some(WorktreeInfo)` if in a secondary worktree

  3. **`is_main_worktree() -> Result<bool>`**
     - Helper to quickly check if cwd is the main worktree

  ### Git worktree list output format
  ```
  worktree /path/to/main
  HEAD abc123
  branch refs/heads/main

  worktree /path/to/worktree
  HEAD def456
  branch refs/heads/feature-x
  ```

  ## Files
  - src/worktree.rs (create)
  - src/lib.rs (add `pub mod worktree;`)

  ## Acceptance
  - [ ] `detect_worktree()` returns `None` when not in a git repo
  - [ ] `detect_worktree()` returns `None` when in main worktree
  - [ ] `detect_worktree()` returns `Some(WorktreeInfo)` when in secondary worktree
  - [ ] `is_main_worktree()` correctly identifies main vs secondary
  - [ ] Tests pass

  ## Produces
  - WorktreeInfo
  - detect_worktree
  - is_main_worktree
closed_at: 2026-02-03T07:36:12.836839Z
close_reason: |-
  Implemented worktree detection module with:
  - `WorktreeInfo` struct with main_path, worktree_path, and branch fields
  - `detect_worktree()` - parses `git worktree list --porcelain` output to detect secondary worktrees
  - `is_main_worktree()` - helper to check if cwd is main worktree
  - Unit tests for parsing and basic smoke tests for detection functions
parent: '12.3'
verify: cargo test worktree::tests::detect
claimed_at: 2026-02-03T07:35:31.821298Z
is_archived: true
