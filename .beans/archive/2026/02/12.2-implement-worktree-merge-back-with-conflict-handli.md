id: '12.2'
title: Implement worktree merge-back with conflict handling
slug: implement-worktree-merge-back-with-conflict-handli
status: closed
priority: 2
created_at: 2026-02-03T03:53:33.463392Z
updated_at: 2026-02-03T04:05:05.412420Z
description: "## Summary\nWhen agent completes in worktree, merge changes back to main.\n\n## Strategy: Option D + C' hybrid\n1. Try `git merge .spro/{id}` (auto-merge)\n2. If clean merge: done âœ“\n3. If conflict:\n   - Keep worktree\n   - Pull conflicting changes into worktree  \n   - Same agent resolves (has context about its own work)\n   - Retry merge\n4. If still conflicts after retry: escalate to human\n\n## Implementation\n```rust\nenum MergeResult {\n    Success,\n    ConflictResolved,\n    ConflictEscalated { files: Vec<String> },\n}\n\nfn merge_worktree(bean_id: &str, allow_retry: bool) -> Result<MergeResult> {\n    let worktree = format!(\".spro/{}\", bean_id);\n    \n    // Try merge\n    let status = Command::new(\"git\")\n        .args([\"merge\", \"--no-ff\", &worktree, \"-m\", &format!(\"[beans-{}] merge\", bean_id)])\n        .status()?;\n    \n    if status.success() {\n        return Ok(MergeResult::Success);\n    }\n    \n    if !allow_retry {\n        // Get conflict files\n        let output = Command::new(\"git\")\n            .args([\"diff\", \"--name-only\", \"--diff-filter=U\"])\n            .output()?;\n        let files = String::from_utf8_lossy(&output.stdout)\n            .lines()\n            .map(|s| s.to_string())\n            .collect();\n        \n        // Abort merge\n        Command::new(\"git\").args([\"merge\", \"--abort\"]).status()?;\n        \n        return Ok(MergeResult::ConflictEscalated { files });\n    }\n    \n    // Option C': Let same agent resolve\n    // 1. Abort merge on main\n    // 2. In worktree: git pull origin main\n    // 3. Agent resolves conflicts there\n    // 4. Retry merge\n    todo!(\"agent conflict resolution\")\n}\n```\n\n## Files\n- /Users/asher/spro/src/worktree.rs\n- /Users/asher/spro/src/spawn.rs (call merge on completion)"
closed_at: 2026-02-03T04:05:05.412420Z
close_reason: Superseded by 12.3 - merge logic moved to bn close
parent: '12'
dependencies:
- '12.1'
verify: cd /Users/asher/spro && cargo test merge_back
is_archived: true
