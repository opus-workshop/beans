id: 12.1.4
title: Implement bn unarchive command
status: closed
priority: 1
created_at: 2026-01-31T00:00:00Z
updated_at: 2026-01-31T17:40:44.637001Z
description: |
  # Implement bn unarchive command

  ## What

  Implement the `bn unarchive <bean-id>` command: move a bean from `.beans/archive/**` back to `.beans/` and commit to git.

  ## Implementation

  ### Files to create/modify

  **Create:**
  - `src/commands/unarchive.rs` — New file, unarchive logic

  **Modify:**
  - `src/commands/mod.rs` — Export `pub fn cmd_unarchive(...)`
  - `src/cli.rs` — Add `Unarchive { id: String }` variant to `Command` enum
  - `src/main.rs` — Add `Command::Unarchive { id }` match arm, call `cmd_unarchive`

  ### What to implement

  **1. In `src/commands/unarchive.rs`:**

  ```rust
  pub fn cmd_unarchive(beans_dir: &Path, id: &str) -> Result<()>
  ```

  Logic:
  1. Find bean in `.beans/archive/**/<id>-*.md` (using `find_archived_bean()`)
  2. Load bean
  3. Compute target path: `.beans/<id>-<slug>.md` (preserve slug from archived bean)
  4. Move file: `std::fs::rename(from, to)`
  5. Set `bean.is_archived = false` and write to new path
  6. Update index (rebuild and save)
  7. Git commit: `git add .beans/; git commit -m "[unarchive] <id>-<slug>"`

  **2. In `src/cli.rs`:**

  Add to `Command` enum:
  ```rust
  Unarchive {
      #[arg(help = "Bean ID to unarchive")]
      id: String,
  },
  ```

  **3. In `src/main.rs`:**

  Add match arm:
  ```rust
  Command::Unarchive { id } => {
      validate_id(&id)?;
      let beans_dir = beans_dir_result.as_ref().unwrap();
      cmd_unarchive(beans_dir, &id)?;
  }
  ```

  ## Patterns to follow

  - Mirror the structure of `cmd_archive()` but in reverse
  - Error handling: See `src/commands/archive.rs` (from sibling bean 12.1.3)
  - Git/index patterns: Same as archive command

  ## Acceptance

  - [ ] `bn unarchive <id>` moves file from `.beans/archive/YYYY/MM/<id>-*.md` to `.beans/<id>-<slug>.md`
  - [ ] Preserves original slug from archived bean
  - [ ] `is_archived: false` set in bean metadata
  - [ ] Index updated after move
  - [ ] Git commit created: `[unarchive] <id>-<slug>`
  - [ ] Proper error messages (bean not found, not archived, already in main dir)
  - [ ] Tests pass: `cargo test`

  ## Notes

  The unarchive is a true reverse of archive—same slug is preserved, same index/git semantics.
closed_at: 2026-01-31T17:40:44.637001Z
close_reason: implemented
parent: '12.1'
dependencies:
- 12.1.2
is_archived: true
