id: 12.1.3
title: Integrate auto-archive into cmd_close
status: closed
priority: 1
created_at: 2026-01-31T00:00:00Z
updated_at: 2026-01-31T17:40:44.637001Z
description: |
  # Integrate auto-archive into cmd_close

  ## What

  Modify `bn close <id>` to automatically move closed beans to `.beans/archive/YYYY/MM/` instead of leaving them in the root `.beans/` directory. This keeps the working directory clean.

  ## Implementation

  ### Files to modify

  - `src/commands/close.rs` — Update `cmd_close()` to archive bean after close succeeds

  ### What to implement

  **In `src/commands/close.rs`:**

  After bean closes successfully (around line 80-100 in current code), before the index rebuild:

  1. Compute archive path using `archive_path_for_bean(beans_dir, &bean.id, slug, date_today)`
  2. Create `.beans/archive/YYYY/MM/` directories if needed (use `std::fs::create_dir_all()`)
  3. Move file: `std::fs::rename(&bean_path, &archive_path)`
  4. Set `bean.is_archived = true`
  5. Write bean to archive path: `bean.to_file(&archive_path)`
  6. Continue with index rebuild + git commit (existing flow)

  Result: same git message `git commit -m "[close] <id> <reason>"` but file is now in archive.

  ### Key changes

  - Import `archive_path_for_bean()` from discovery module
  - Use `chrono::Local::now().naive_local().date()` to get today's date for archive path
  - Preserve existing error handling and commit logic

  ### No CLI changes needed

  - `bn close <id>` works exactly as before from user perspective
  - Beans just end up in archive instead of root

  ## Patterns to follow

  - See `src/commands/close.rs` current logic for where to insert archive logic
  - Follow existing error handling for file operations
  - Keep git operations the same (one commit per close)

  ## Acceptance

  - [ ] `bn close <id>` closes bean AND moves to `.beans/archive/YYYY/MM/<id>-<slug>.md`
  - [ ] Archive directories created if needed
  - [ ] `is_archived: true` in bean metadata
  - [ ] Index updated after move
  - [ ] Git commit still works: `[close] <id> <reason>`
  - [ ] Error handling preserves existing close error messages
  - [ ] Tests pass: `cargo test`
  - [ ] Verify with manual test: `bn close <some-open-bean>` then `ls .beans/archive/2026/01/`

  ## Notes

  This is the key behavior change—archive happens automatically on close, no separate command needed.
closed_at: 2026-01-31T17:40:44.637001Z
close_reason: implemented
parent: '12.1'
dependencies:
- 12.1.2
is_archived: true
