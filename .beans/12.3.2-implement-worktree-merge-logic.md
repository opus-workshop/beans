id: 12.3.2
title: Implement worktree merge logic
slug: implement-worktree-merge-logic
status: in_progress
priority: 2
created_at: 2026-02-03T07:27:24.184830Z
updated_at: 2026-02-03T07:36:20.439093Z
description: |
  ## What to implement

  Add merge and cleanup functions to `src/worktree.rs`.

  ### Functions to write

  1. **`MergeResult` enum**
     ```rust
     pub enum MergeResult {
         Success,
         Conflict { files: Vec<String> },
         NothingToCommit,
     }
     ```

  2. **`commit_worktree_changes(message: &str) -> Result<bool>`**
     - Run `git add -A`
     - Run `git commit -m <message>`
     - Return `true` if commit was made, `false` if nothing to commit

  3. **`merge_to_main(info: &WorktreeInfo, bean_id: &str) -> Result<MergeResult>`**
     - From main worktree: `git -C <main_path> merge <branch> --no-ff -m "..."`
     - If conflict: abort merge, return `Conflict { files }`
     - If clean: return `Success`

  4. **`cleanup_worktree(info: &WorktreeInfo) -> Result<()>`**
     - Remove the worktree: `git worktree remove <worktree_path>`
     - Delete the branch: `git branch -d <branch>`

  ## Context

  ### WorktreeInfo (from 12.3.1)
  ```rust
  pub struct WorktreeInfo {
      pub main_path: PathBuf,
      pub worktree_path: PathBuf,
      pub branch: String,
  }
  ```

  ## Files
  - src/worktree.rs (modify â€” add merge functions)

  ## Acceptance
  - [ ] `commit_worktree_changes` stages and commits all changes
  - [ ] `commit_worktree_changes` returns false when nothing to commit
  - [ ] `merge_to_main` performs no-ff merge to main branch
  - [ ] `merge_to_main` detects and reports conflicts
  - [ ] `cleanup_worktree` removes worktree and deletes branch
  - [ ] Tests pass

  ## Produces
  - MergeResult
  - commit_worktree_changes
  - merge_to_main
  - cleanup_worktree


  ## Requires
  - WorktreeInfo
  - detect_worktree
parent: '12.3'
verify: cargo test worktree::tests::merge
claimed_at: 2026-02-03T07:36:20.439093Z
