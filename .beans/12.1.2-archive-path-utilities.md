---
id: 12.1.2
title: Build archive path and discovery utilities
status: open
priority: 1
parent: 12.1
dependencies:
  - 12.1.1
created_at: 2026-01-31T00:00:00Z
updated_at: 2026-01-31T00:00:00Z
---

# Build archive path and discovery utilities

## What

Create utility functions for computing archive paths and discovering archived beans. This is shared infrastructure used by both `archive` and `unarchive` commands.

## Implementation

### Files to modify
- `src/discovery.rs` â€” Add two new functions

### What to implement

**1. Compute archive path for a bean:**

```rust
/// Given a bean id, slug, and current date, compute the archive path:
/// .beans/archive/YYYY/MM/<id>-<slug>.md
pub fn archive_path_for_bean(
    beans_dir: &Path,
    id: &str,
    slug: &str,
    date: chrono::NaiveDate,
) -> PathBuf
```

Returns: `.beans/archive/2026/01/12-bean-archive-system.md`

**2. Find an archived bean:**

```rust
/// Search .beans/archive/** for a bean by ID.
/// Scans all year/month subdirs, returns first match.
/// Returns error if not found.
pub fn find_archived_bean(beans_dir: &Path, id: &str) -> Result<PathBuf>
```

Uses the same `extract_id_from_filename()` logic as `find_bean_file()` to match by ID prefix.

## Patterns to follow

See `src/discovery.rs::find_bean_file()` for:
- ID prefix matching (handles {id}-{slug}.md and {id}.yaml)
- Error handling patterns
- Directory recursion if needed (use `walkdir` crate if available, else simple fs::read_dir)

## Acceptance

- [ ] `archive_path_for_bean()` computes correct path: `.beans/archive/YYYY/MM/<id>-<slug>.md`
- [ ] Creates missing parent directories when called (implicit in later commands)
- [ ] `find_archived_bean()` searches archive subdirs recursively
- [ ] Returns `Err` if bean not found in archive
- [ ] Tests pass: `cargo test`
- [ ] Handles edge cases: missing archive dir, malformed filenames

## Notes

These are stateless utility functions. The actual move/git operations happen in the archive/unarchive commands.
