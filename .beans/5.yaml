id: '5'
title: Implement smart selectors (@latest, @blocked, @parent, @me)
status: closed
priority: 2
created_at: 2026-01-31T16:51:48.920128Z
updated_at: 2026-01-31T16:51:48.920128Z
description: |-
  Implement a selector resolution system that allows relative bean referencing using @-prefixed keywords throughout the CLI. This enables powerful shortcuts like 'bn show @latest' to view the most recently created bean, 'bn close @blocked' to close all blocked beans, 'bn show @parent' to view a bean's parent, and 'bn show @me' to view beans assigned to the current user.

  ## Design Overview

  Selectors are special bean ID patterns prefixed with '@' that resolve to concrete bean IDs at command execution time. The resolution system operates in two phases:

  1. **Parsing**: Detect @ prefix and categorize selector type
  2. **Resolution**: Query index to resolve selector to actual bean ID(s)

  ## Architecture

  Create new module: src/selector.rs

  Key types:
  - enum SelectorType { Latest, Blocked, Parent, Me }
  - fn parse_selector(input: &str, context: &SelectionContext) -> Result<SelectorType>
  - fn resolve_selector(selector: SelectorType, index: &Index, context: &SelectionContext) -> Result<Vec<String>>

  The resolution context includes:
  - beans_dir: Path
  - index: &Index (pre-loaded for efficiency)
  - current_bean_id: Option<String> (for @parent)
  - current_user: String (for @me, read from env or config)

  ## Selectors

  ### @latest
  - Query: Find bean with max updated_at timestamp
  - Returns: Single bean ID
  - Error: 'No beans found' if index empty

  ### @blocked
  - Query: Filter index for open beans with unresolved dependencies
  - Returns: Vec of bean IDs (all blocked beans)
  - Error: Return empty vec if no blocked beans (not an error)

  ### @parent
  - Requires context: Must know which bean we're operating on
  - Resolves: From bean.parent field
  - Returns: Single parent bean ID
  - Errors: 'Bean {id} has no parent' / 'Parent {parent_id} not found'

  ### @me
  - Requires: Current user from env var BN_USER or config file
  - Query: Filter for beans where assignee == current_user AND status \!= closed
  - Returns: Vec of bean IDs
  - Error: 'BN_USER not set' or 'No user configured'

  ## Integration Points

  ### Phase 1: Parsing & Core Resolution (selector.rs)
  - pure functions for selector type detection
  - selector resolution given index + context
  - comprehensive unit tests for all selector types

  ### Phase 2: CLI Integration
  Points where selectors resolve to IDs:

  1. cmd_show: Parse id arg, resolve selector if needed
  2. cmd_close: Parse ids args, resolve selectors, expand to list
  3. cmd_update: Parse id arg, resolve selector
  4. cmd_dep_add: Parse id + depends_on args, resolve both
  5. cmd_dep_remove: Parse id + depends_on args, resolve both
  6. cmd_verify: Parse id arg, resolve selector

  Main validation logic stays in main.rs but now accepts '@' syntax

  ## Edge Cases & Error Handling

  1. **@parent with no parent**: Error 'Bean 3 has no parent'
  2. **@blocked with no blocked beans**: Return empty vec
  3. **@me with no user configured**: Error 'BN_USER environment variable not set'
  4. **@latest when index empty**: Error 'No beans found'

  ## Testing Strategy

  ### Unit Tests (selector.rs)
  - parse_selector: Valid @latest, @blocked, @parent, @me
  - resolve_latest: With N beans, returns most recent
  - resolve_blocked: With various dependencies, returns correct blocked set
  - resolve_parent: Valid parent, no parent, parent not found
  - resolve_me: User set/unset, matching/non-matching assignees

  ### Integration Tests
  - cmd_show with @latest, @blocked, @parent, @me
  - cmd_close with @blocked → closes all blocked
  - cmd_update with @me → updates all my beans
acceptance: |2-

  - Selector parsing correctly identifies @-prefixed keywords vs literal IDs
  - @latest returns bean with max updated_at; errors on empty index
  - @blocked returns all open beans with unresolved dependencies
  - @parent resolves to parent bean ID with proper error handling
  - @me returns all open beans for current user (from BN_USER env var)
  - All selector types integrate with show, close, update, dep commands
  - Proper error messages for edge cases (no parent, no user, etc.)
  - Selector resolution uses pre-loaded index for efficiency
  - Unit test coverage >90%
  - Integration tests verify command-level selector usage
verify: "\n# Run all selector tests\ncargo test selector --lib 2>&1 | tail -5 &&\ncargo test --test '*' 2>&1 | tail -5 &&\n# Verify selector parsing\ncargo test selector::parse_ --lib 2>&1 | grep -E 'test result|running' &&\n# Quick compile check  \ncargo build --release 2>&1 | tail -3"
