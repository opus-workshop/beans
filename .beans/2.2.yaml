id: '2.2'
title: Implement schema validation and file saving for bn edit
status: open
priority: 2
created_at: 2026-01-31T17:02:04.960309Z
updated_at: 2026-01-31T17:02:04.960309Z
description: |-
  Implement validation and persistence for bn edit command.

  ## What to Implement
  Extend src/commands/edit.rs with:
  - fn validate_and_save(path: &Path, content: &str) -> Result<()>
    - Parse content with Bean::from_string() to validate schema
    - On parse error: return Err with validation message
    - On parse success: write content to file, update timestamps
    - Update updated_at field to Utc::now()

  - fn rebuild_index_after_edit(beans_dir: &Path) -> Result<()>
    - Call Index::build(beans_dir)
    - Save index to .beans/index.yaml
    - Reuse pattern from cmd_update.rs

  - fn prompt_rollback(backup: &[u8], path: &Path) -> Result<()>
    - Show validation error to user
    - Ask: 'Retry in editor? (y/n/rollback?)'
    - If rollback: restore from backup
    - If retry: return to editor
    - If abort: fail

  ## Files
  - src/commands/edit.rs (extend from 2.1)

  ## Integration
  - Use Bean::from_string() from bean.rs
  - Use Index::build() from index.rs
  - Use Utc::now() for timestamps

  ## Testing
  - Test: invalid YAML after edit triggers validation error
  - Test: valid edit persists changes
  - Test: updated_at increments
  - Test: index rebuilt after save
  - Test: rollback restores original content
acceptance: |-
  - validate_and_save() parses and validates schema
  - Invalid YAML shows error message with line info
  - Valid changes persist to disk
  - updated_at timestamp increments after successful edit
  - Index is rebuilt and saved after edit
  - Rollback prompt appears on validation error
  - Rollback restores original file content
  - Can distinguish between retry/rollback/abort
  - cargo test passes
parent: '2'
dependencies:
- '2.1'
verify: cargo test --lib commands::edit::validate
