id: '4.5'
title: Integrate pre-close hook as CI gatekeeper into cmd_close
status: open
priority: 2
created_at: 2026-01-31T17:02:44.316787Z
updated_at: 2026-01-31T17:02:44.316787Z
description: |-
  Add pre-close hook to bean closing workflow for CI gatekeeper.

  ## What to Modify
  In src/commands/close.rs:

  In cmd_close() function:
  Before running verify command:
  - Call execute_hook(HookEvent::PreClose, &bean, beans_dir)?
  - Pass reason parameter if available
  - If hook returns false: abort with 'Bean closing blocked by pre-close hook'
  - If hook error: print stderr, abort
  - Hook can check test results, code review, etc.

  Hook payload includes optional 'reason' field:
  - Pre-close: { "event": "pre-close", "bean": {...}, "reason": "optional reason" }

  ## Use Case Example
  A hook script could:
  - Extract test files from bean description
  - Run those tests
  - Exit 0 if all pass
  - Exit 1 if any fail
  - This blocks bean close if tests don't pass

  ## Pattern to Follow
  - Pre-close is blocking
  - Run before verify command
  - Hook can perform validation
  - Capture and show stderr on failure

  ## Testing
  - Test: pre-close hook runs before verify
  - Test: pre-close hook can block close
  - Test: pre-close hook failure prevents close
  - Integration test: close bean, verify hook called
  - Example: create a test hook that validates
acceptance: |-
  - pre-close hook runs before bean close
  - Hook can block close if it exits non-zero
  - Hook receives reason parameter if provided
  - pre-close failure shows error and prevents close
  - Bean stays open if pre-close hook fails
  - Verify command runs after pre-close succeeds
  - Hook stderr visible to user on failure
  - Untrusted hooks silently skipped
  - Can use hook to validate tests before close
  - cargo test passes
parent: '4'
dependencies:
- '4.2'
verify: cargo test --lib commands::close
