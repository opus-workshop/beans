---
id: 13.3
title: Update file discovery to find beans by {id}-{slug}.md pattern
status: open
priority: 1
created_at: 2026-01-30T00:00:00Z
updated_at: 2026-01-30T00:00:00Z
parent: 13
dependencies: [13.1, 13.2]
type: task
---

# Update file discovery to find beans by {id}-{slug}.md pattern

## What

Update `src/discovery.rs` and `src/lib.rs` to find bean files matching the new naming convention: `{id}-{slug}.md`

**Current behavior:**
- Assumes filenames like `1.yaml`, `2.yaml`, `11.1.yaml`
- Directly constructs path: `.beans/{id}.yaml`

**New behavior:**
- Filenames are `1-project-scaffolding.md`, `11.1-refactor-md-parser.md`
- Must glob for `.beans/{id}-*.md` and find the first match
- Return the full path with slug

## Implementation

Add function to `src/discovery.rs`:

```rust
/// Find a bean file by ID, supporting new {id}-{slug}.md naming.
///
/// Given ID "11.1", searches for ".beans/11.1-*.md"
/// Returns the full path if found.
///
/// # Examples
/// - `find_bean_file("11.1")` → `.beans/11.1-refactor-md-parser.md`
pub fn find_bean_file(beans_dir: &Path, id: &str) -> Result<PathBuf> {
    // Validate ID
    crate::util::validate_bean_id(id)?;

    // Build glob pattern: {id}-*.md
    let pattern = format!("{}/*.md", beans_dir.display());

    // Use glob to search
    for entry in glob::glob(&pattern).context("glob pattern failed")? {
        let path = entry?;
        if let Some(filename) = path.file_name().and_then(|n| n.to_str()) {
            // Check if filename matches {id}-*.md
            if filename.starts_with(&format!("{}-", id)) && filename.ends_with(".md") {
                return Ok(path);
            }
        }
    }

    Err(anyhow::anyhow!("Bean {} not found", id))
}
```

**Integration points:**
- Update any code that does `.beans/{id}.yaml` lookups
- Use this function in all file operations (show, update, delete, etc.)

## Code locations

- `src/discovery.rs` — Add `find_bean_file()` function
- `src/lib.rs` — Export and possibly use in public API
- Update glob pattern matching logic if exists

## Dependencies

- May need to add `glob` crate to Cargo.toml (if not already present)

## Acceptance

- [ ] Function finds beans by ID prefix pattern
- [ ] Handles hierarchical IDs (11.1, 11.2, etc.)
- [ ] Returns correct PathBuf with slug included
- [ ] Returns error if bean not found
- [ ] Validates ID to prevent path traversal
- [ ] Tests cover:
  - Finding by flat ID (1, 2, 11)
  - Finding by hierarchical ID (11.1, 11.2)
  - Not found case
  - Invalid ID case
- [ ] `cargo test discovery::find_bean_file` passes

## Testing

```bash
# Create test files
touch .beans/1-test-bean.md
touch .beans/11.1-child-bean.md

# Test function finds them
cargo test find_bean_file
```

Verify:
- `find_bean_file(beans_dir, "1")` returns `.beans/1-test-bean.md`
- `find_bean_file(beans_dir, "11.1")` returns `.beans/11.1-child-bean.md`
- Returns error when bean not found
