id: 4
title: Index engine
status: open
priority: 0
dependencies:
  - 2
created_at: 2026-01-26T15:00:00-08:00
updated_at: 2026-01-26T15:00:00-08:00
description: |
  Build the auto-rebuilding index cache that powers read-heavy commands.

  ## What to implement

  ### Index struct — src/index.rs
  ```rust
  pub struct Index {
      pub beans: Vec<IndexEntry>,
  }

  pub struct IndexEntry {
      pub id: String,
      pub title: String,
      pub status: Status,
      pub priority: u8,
      pub parent: Option<String>,
      pub dependencies: Vec<String>,
      pub labels: Vec<String>,
      pub updated_at: DateTime<Utc>,
  }
  ```

  ### Index::build(beans_dir) -> Result<Index>
  Glob .beans/*.yaml (excluding config.yaml, index.yaml, bean.yaml),
  parse each as Bean, extract IndexEntry fields. Sort by id.

  ### Index::is_stale(beans_dir) -> Result<bool>
  Compare index.yaml mtime against all *.yaml file mtimes.
  If any YAML file is newer than index.yaml, index is stale.
  If index.yaml doesn't exist, it's stale.

  ### Index::load_or_rebuild(beans_dir) -> Result<Index>
  If is_stale, call build() and save(). Otherwise load from index.yaml.
  This is the main entry point — all read commands call this.

  ### Index::save(&self, beans_dir) -> Result<()>
  Serialize to .beans/index.yaml.

  ## Files
  - src/index.rs (create)

  ## Context needed
  - src/bean.rs: Bean struct and Status enum (from bean 2)

  ## Patterns
  - Use std::fs::metadata().modified() for mtime comparison
  - Glob with std::fs::read_dir, filter by extension
  - Exclude: config.yaml, index.yaml, bean.yaml
  - Sort entries by id (natural sort: 1, 2, 3, 3.1, 3.2, 10)

  ## Note on natural sorting
  IDs like "1", "2", "3.1", "3.2", "10" should sort naturally:
  1, 2, 3, 3.1, 3.2, 10 — not lexicographic 1, 10, 2, 3, 3.1, 3.2.
  Split on dots, compare each segment numerically.

acceptance: |
  - Index::build correctly reads all bean YAML files
  - Index::build excludes config.yaml, index.yaml, bean.yaml
  - Index::is_stale returns true when any YAML is newer than index
  - Index::is_stale returns true when index.yaml doesn't exist
  - Index::load_or_rebuild rebuilds when stale, loads when fresh
  - IDs sort naturally (1, 2, 3, 3.1, 3.2, 10)
  - cargo build succeeds
  - cargo test passes
