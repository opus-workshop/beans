id: '12.3'
title: Add worktree merge to bn close
slug: add-worktree-merge-to-bn-close
status: open
priority: 2
created_at: 2026-02-03T04:03:38.686698Z
updated_at: 2026-02-03T07:27:36.906627Z
description: |-
  ## Summary
  When `bn close` runs in a git worktree, handle merge automatically.

  ## Flow
  1. Verify passes (existing)
  2. Detect if in worktree: `git rev-parse --is-inside-work-tree` + `git worktree list`
  3. Commit all changes: `git add -A && git commit`
  4. Merge to main:
     - `git checkout main`
     - `git merge <worktree-branch> --no-ff`
  5. If conflict: abort, return to worktree, tell agent to resolve
  6. If clean: archive bean, remove worktree

  ## Implementation

  ```rust
  fn detect_worktree() -> Result<Option<WorktreeInfo>> {
      let output = Command::new("git")
          .args(["worktree", "list", "--porcelain"])
          .output()?;
      // Parse to find if cwd is a worktree (not main)
      // Return main path and current worktree path
  }

  fn merge_to_main(bean_id: &str) -> Result<MergeResult> {
      // Get main worktree path
      // git -C <main> merge <worktree-branch>
      // Return Success or Conflict { files }
  }
  ```

  ## Files
  - src/commands/close.rs
  - src/worktree.rs (new module)

  ## Edge cases
  - Not in git repo: skip worktree logic
  - In main worktree: skip (no merge needed)
  - Dirty main: error or stash?
  - Nested beans in same worktree?
parent: '12'
dependencies:
- '11'
verify: cargo test close::tests::worktree_merge
