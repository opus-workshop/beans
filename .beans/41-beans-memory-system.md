id: '41'
title: Beans Memory System
slug: beans-memory-system
status: open
priority: 2
created_at: 2026-02-05T18:33:19.000683Z
updated_at: 2026-02-05T18:47:19.828248Z
description: "# Beans Memory System\n\nTransform beans from a task tracker into a verified knowledge graph with temporal state.\n\n## Core Insight\n\nTasks and memories are the same data structure with different lifecycles:\n- Task: \"needs to happen\" → work → \"happened\" (verified)  \n- Memory: \"is true\" → time → \"still true?\" (re-verified)\n\nBoth need hierarchy, relationships, search, scoping, and validation. Beans already has the primitives.\n\n## Knowledge Separation\n\n| Type | Where | Verification |\n|------|-------|--------------|\n| Verifiable facts | `bn fact` | **Required** — that's the point |\n| Unverifiable knowledge | `agents.md` | None — prose, conventions, preferences |\n| Tasks | `bn create` | Required — completion gate |\n\n**If you can't write a verify command, it's not a bn fact — it belongs in agents.md.**\n\n## What This Enables\n\n### Passive Memory (automatic)\n- Closed beans → episodic memory (what happened, with close reasons)\n- Failed attempts → negative memory (what didn't work)\n- Verification failures → staleness detection\n\n### Active Memory (explicit)\n- `bn fact` → verified semantic knowledge with proof (verify required)\n\n### Retrieval\n- `bn context` → auto-injected relevant memories at session start\n- `bn recall` → search when needed (substring MVP, embeddings roadmap)\n\n### Maintenance\n- `bn verify --facts` → re-check all facts, detect staleness\n- Dependency invalidation → suspect propagation through produces/requires graph\n\n## Key Design Principles\n\n1. **Facts ARE beans** — same commands, just `--type=fact`\n2. **Facts require verification** — no verify = not a fact, use agents.md\n3. **Verification unifies everything** — tasks verify completion, facts verify truth\n4. **Passive over active** — context injected, not queried\n5. **UNIX-friendly** — text output, pipeable, composable\n6. **Graceful degradation** — works without embeddings, without global scope\n7. **Self-healing** — stale facts surface automatically\n\n## bn context: The Keystone\n\nReturns relevant memories for RIGHT NOW. Designed for session-start injection.\n\n**Sections (priority order):**\n1. WARNINGS — stale facts, past failures (never truncated)\n2. WORKING ON — claimed beans with attempt history\n3. RELEVANT FACTS — scored by path overlap, dependencies\n4. RECENT WORK — closed beans from last 7 days\n\n**Relevance scoring (MVP, no embeddings):**\n```\nscore = path_overlap × 3 + dependency_match × 5 + recency × 1\n```\n\n**Token budget:** ~4000 default, truncate from bottom (recent work first)\n\n**Output format:**\n```\n═══ BEANS CONTEXT ═══════════════════════════════════════════\n\n⚠ WARNINGS\n│ STALE: \"Session timeout is 24h\" — not verified in 35d\n│ PAST FAILURE [2.1]: \"token not in httponly cookie\"\n\n► WORKING ON\n│ [2.1] Implement JWT refresh tokens\n│   Attempt #2 (previous: \"httponly cookie issue\")\n\n✓ RELEVANT FACTS\n│ \"Auth uses RS256 signing\" ✓ 1d ago\n\n◷ RECENT WORK\n│ [2.0] Auth module setup (closed 2d ago)\n│   \"Created JwtClaims, RS256 with env vars...\"\n```\n\n## Attempt Tracking\n\nWhen an agent claims a bean and fails, that's valuable knowledge.\n\n- **Start**: `bn claim` starts an attempt\n- **End**: `bn close` (success), `bn close --failed` (failure), `bn claim --release` (abandoned)\n- Attempts stored as JSON array: `[{num, outcome, notes}]`\n- `bn context` surfaces past failures to prevent repeating mistakes\n\n## Staleness\n\n- Default TTL: 30 days (configurable via `--ttl`)\n- Facts not verified within TTL show as warnings in `bn context`\n- `bn verify --facts` re-runs all fact verifications\n- Suspect propagation: facts requiring invalid facts become suspect (depth limit 3)\n\n## Schema Additions\n\n```sql\nALTER TABLE beans ADD COLUMN bean_type TEXT DEFAULT 'task';\n  -- 'task' | 'fact'\n\nALTER TABLE beans ADD COLUMN scope TEXT DEFAULT 'project';\n  -- 'project' | 'global'\n\nALTER TABLE beans ADD COLUMN last_verified INTEGER;\n  -- Unix timestamp of last successful verify\n\nALTER TABLE beans ADD COLUMN stale_after INTEGER;\n  -- Unix timestamp = created + ttl (default 30 days)\n\nALTER TABLE beans ADD COLUMN paths TEXT;\n  -- JSON array: [\"src/auth.rs\"] for relevance matching\n\nALTER TABLE beans ADD COLUMN attempts TEXT;\n  -- JSON array: [{num, outcome, notes}]\n```\n\n## Roadmap (not MVP)\n\n- **Embeddings**: Semantic search for `bn recall`, embedding-based relevance in `bn context`\n- **Global scope**: ~/.beans/global.db for cross-project facts\n- **Model choice**: TBD (voyage-code-3, voyage-2, local, etc.)\n\n## Implementation Phases\n\n### Phase 1: Foundation\n- Schema migration (add columns)\n- Attempt tracking (start/end/failed flow)\n\n### Phase 2: Context\n- `bn context` command (path + dependency relevance, no embeddings)\n- Token budget and truncation\n\n### Phase 3: Facts\n- `bn fact` command (requires --verify)\n- `bn verify --facts` (staleness detection, suspect propagation)\n\n### Phase 4: Search\n- `bn recall` (substring search MVP)\n- Skill update (teach agents the workflow)\n\n### Future\n- Embedding-based semantic search\n- Global scope\n- Auto-injection in pi\n\n## Files\n\n- packages/beans/src/db.ts — schema migration\n- packages/beans/src/commands/context.ts — new command\n- packages/beans/src/commands/fact.ts — convenience wrapper  \n- packages/beans/src/commands/recall.ts — search command\n- packages/beans/src/commands/verify.ts — extend for --facts\n- packages/beans/src/relevance.ts — scoring algorithm\n- skills/beans/SKILL.md — update with memory workflow"
verify: cd packages/beans && npm test
tokens: 1391
tokens_updated: 2026-02-05T18:47:19.828247Z
