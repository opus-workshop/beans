id: 12.3.3
title: Integrate worktree merge into bn close
slug: integrate-worktree-merge-into-bn-close
status: in_progress
priority: 2
created_at: 2026-02-03T07:27:24.189466Z
updated_at: 2026-02-03T07:37:25.545502Z
description: "## What to implement\n\nModify `cmd_close` in `src/commands/close.rs` to handle worktree merge after verify passes.\n\n### Changes to make\n\n1. **Add worktree handling to `cmd_close()`**\n   \n   After verify passes and before archiving, add:\n   ```rust\n   // After verify passes, handle worktree merge\n   if let Some(worktree_info) = detect_worktree()? {\n       // Commit any uncommitted changes\n       commit_worktree_changes(&format!(\"Close bean {}: {}\", id, bean.title))?;\n       \n       // Merge to main\n       match merge_to_main(&worktree_info, id)? {\n           MergeResult::Success | MergeResult::NothingToCommit => {\n               // Continue to archive\n           }\n           MergeResult::Conflict { files } => {\n               eprintln!(\"Merge conflict in files: {:?}\", files);\n               eprintln!(\"Resolve conflicts and run `bn close {}` again\", id);\n               return Ok(()); // Don't archive yet\n           }\n       }\n       \n       // Clean up worktree after successful close\n       // (done after archiving)\n   }\n   ```\n\n2. **Add integration tests**\n   - Test close in worktree commits and merges\n   - Test close with merge conflict aborts cleanly\n   - Test close in main worktree skips merge logic\n\n## Context\n\n### cmd_close signature\n```rust\npub fn cmd_close(\n    beans_dir: &Path,\n    ids: Vec<String>,\n    reason: Option<String>,\n    force: bool,\n) -> Result<()>\n```\n\n### Worktree functions (from 12.3.1, 12.3.2)\n```rust\npub fn detect_worktree() -> Result<Option<WorktreeInfo>>;\npub fn commit_worktree_changes(message: &str) -> Result<bool>;\npub fn merge_to_main(info: &WorktreeInfo, bean_id: &str) -> Result<MergeResult>;\npub fn cleanup_worktree(info: &WorktreeInfo) -> Result<()>;\n```\n\n## Files\n- src/commands/close.rs (modify â€” add worktree handling)\n\n## Edge cases to handle\n- Not in git repo: skip worktree logic (detect_worktree returns None)\n- In main worktree: skip (detect_worktree returns None)\n- Dirty main: merge_to_main should error\n- Merge conflict: abort, leave bean open, tell user to resolve\n\n## Acceptance\n- [ ] `bn close` in worktree commits changes and merges to main\n- [ ] `bn close` with conflict aborts and provides guidance\n- [ ] `bn close` in main worktree works as before (no merge)\n- [ ] `bn close` outside git repo works as before\n- [ ] Integration tests pass\n\n## Produces\n- close_worktree_integration\n\n\n## Requires\n- detect_worktree\n- commit_worktree_changes\n- merge_to_main\n- cleanup_worktree\n"
parent: '12.3'
verify: cargo test close::tests::worktree_merge
claimed_at: 2026-02-03T07:37:25.545502Z
