id: '12.1'
title: Implement git worktree isolation in spro spawn
slug: implement-git-worktree-isolation-in-spro-spawn
status: in_progress
priority: 2
created_at: 2026-02-03T03:53:20.160798Z
updated_at: 2026-02-03T05:02:37.164217Z
description: |-
  ## Summary
  Modify spawn.rs to create isolated git worktree for each agent.

  ## Current flow (spawn.rs)
  1. undo checkpoint before-{id}
  2. bn claim {id}
  3. pi --mode json ... (works in main directory)
  4. Agent closes bean

  ## New flow
  1. git worktree add .spro/{id} HEAD
  2. cd .spro/{id}
  3. bn claim {id} (verify-on-claim runs here if enabled)
  4. pi --mode json ... (works in isolated worktree)
  5. On success: merge worktree back
  6. git worktree remove .spro/{id}

  ## Implementation
  ```rust
  fn create_worktree(bean_id: &str) -> Result<PathBuf> {
      let worktree_path = PathBuf::from(format!(".spro/{}", bean_id));
      Command::new("git")
          .args(["worktree", "add", worktree_path.to_str().unwrap(), "HEAD"])
          .status()?;
      Ok(worktree_path)
  }

  fn merge_worktree(bean_id: &str) -> Result<()> {
      // Option D + C' hybrid:
      // 1. Try git merge
      // 2. If conflict, let same agent resolve OR requeue
      todo!()
  }

  fn cleanup_worktree(bean_id: &str) -> Result<()> {
      let worktree_path = format!(".spro/{}", bean_id);
      Command::new("git")
          .args(["worktree", "remove", &worktree_path])
          .status()?;
      Ok(())
  }
  ```

  ## Files
  - /Users/asher/spro/src/spawn.rs
  - /Users/asher/spro/src/worktree.rs (new)

  ## Edge cases
  - Non-git repos: fall back to current behavior
  - Nested worktrees: error
  - Dirty working tree: stash or error?
parent: '12'
verify: cd /Users/asher/spro && cargo test worktree
claimed_at: 2026-02-03T05:02:37.164217Z
